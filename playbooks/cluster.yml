---
- name: Common tasks for every playbooks
  import_playbook: boilerplate.yml

- name: Gather facts
  import_playbook: internal_facts.yml

- name: Run KVM preflight checks on worker nodes
  hosts: kube_node
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env | default({}) }}"
  roles:
    - { role: kvm_preflight }

- name: Prepare for etcd install
  hosts: k8s_cluster:etcd
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env }}"
  roles:
    - { role: kubespray_defaults }
    - { role: kubernetes/preinstall, tags: preinstall }
    - { role: "container-engine", tags: "container-engine", when: deploy_container_engine }
    - { role: download, tags: download, when: "not skip_downloads" }

- name: Install etcd
  vars:
    etcd_cluster_setup: true
    etcd_events_cluster_setup: "{{ etcd_events_cluster_enabled }}"
  import_playbook: install_etcd.yml

- name: Install Kubernetes nodes
  hosts: k8s_cluster
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env }}"
  roles:
    - { role: kubespray_defaults }
    - { role: kubernetes/node, tags: node }

- name: Install the control plane
  hosts: kube_control_plane
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env }}"
  roles:
    - { role: kubespray_defaults }
    - { role: kubernetes/control-plane, tags: control-plane }
    - { role: kubernetes/client, tags: client }
    - { role: kubernetes-apps/cluster_roles, tags: cluster-roles }

- name: Invoke kubeadm and install a CNI
  hosts: k8s_cluster
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env }}"
  roles:
    - { role: kubespray_defaults }
    - { role: kubernetes/kubeadm, tags: kubeadm}
    - { role: kubernetes/node-label, tags: node-label }
    - { role: kubernetes/node-taint, tags: node-taint }
    - { role: kubernetes-apps/common_crds }
    - { role: network_plugin, tags: network }

- name: Install Calico Route Reflector
  hosts: calico_rr
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env }}"
  roles:
    - { role: kubespray_defaults }
    - { role: network_plugin/calico/rr, tags: ['network', 'calico_rr'] }

- name: Patch Kubernetes for Windows
  hosts: kube_control_plane[0]
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env }}"
  roles:
    - { role: kubespray_defaults }
    - { role: win_nodes/kubernetes_patch, tags: ["control-plane", "win_nodes"] }

- name: Install Kubernetes apps
  hosts: kube_control_plane
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env }}"
  roles:
    - { role: kubespray_defaults }
    - { role: kubernetes-apps/external_cloud_controller, tags: external-cloud-controller }
    - { role: kubernetes-apps/policy_controller, tags: policy-controller }
    - { role: kubernetes-apps/ingress_controller, tags: ingress-controller }
    - { role: kubernetes-apps/external_provisioner, tags: external-provisioner }
    - { role: kubernetes-apps, tags: apps }

- name: Apply resolv.conf changes now that cluster DNS is up
  hosts: k8s_cluster
  gather_facts: false
  any_errors_fatal: "{{ any_errors_fatal | default(true) }}"
  environment: "{{ proxy_disable_env }}"
  roles:
    - { role: kubespray_defaults }
    - { role: kubernetes/preinstall, when: "dns_mode != 'none' and resolvconf_mode == 'host_resolvconf'", tags: resolvconf, dns_late: true }

- name: Copy admin kubeconfig to control-plane users
  hosts: kube_control_plane
  become: true
  tasks:
    - name: Ensure user kube dir exists
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0700"

    - name: Copy admin.conf for user
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"
        remote_src: true

- name: Enforce kubeconfig location under ansible user
  hosts: kube_control_plane
  become: true
  tags:
    - kubeconfig_admin
    - external_kubeconfig
  tasks:
    - name: Ensure kube dir exists for ansible user
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0700"

    - name: Copy /etc/kubernetes/admin.conf to ansible user home
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"
        remote_src: true

    - name: Remove root kubeconfig copy
      ansible.builtin.file:
        path: /root/.kube/config
        state: absent

- name: Configure external kubeconfig for kube-vip
  hosts: kube_control_plane[0]
  gather_facts: false
  become: false
  vars:
    kubeconfig_user_home: "{{ ansible_user_dir | default(ansible_env.HOME) }}"
    kubeconfig_path: "{{ kubeconfig_user_home }}/.kube/config"
    kubeconfig_external_path: "{{ kubeconfig_user_home }}/.kube/config-external"
  tags:
    - external_kubeconfig
  tasks:
    - name: Skip external kubeconfig when feature disabled
      ansible.builtin.meta: end_play
      when: not configure_external_kubeconfig | default(false)
    - name: Check admin.conf presence
      become: true
      stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_stat

    - name: Fail if admin.conf is missing
      fail:
        msg: "/etc/kubernetes/admin.conf not found; control plane not initialized"
      when: not admin_conf_stat.stat.exists

    - name: Ensure user kube dir exists for external config
      become: true
      file:
        path: "{{ kubeconfig_user_home }}/.kube"
        state: directory
        mode: "0700"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Stat main kubeconfig
      stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_stat

    - name: Copy admin.conf to user kubeconfig if missing
      become: true
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "{{ kubeconfig_path }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"
        remote_src: true
      when: not kubeconfig_stat.stat.exists

    - name: Stat external kubeconfig
      stat:
        path: "{{ kubeconfig_external_path }}"
      register: external_kubeconfig_stat

    - name: Copy kubeconfig to external variant when missing
      become: true
      copy:
        src: "{{ kubeconfig_path }}"
        dest: "{{ kubeconfig_external_path }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"
        remote_src: true
      when: not external_kubeconfig_stat.stat.exists

    - name: Point external kubeconfig to kube-vip VIP
      replace:
        path: "{{ kubeconfig_external_path }}"
        regexp: 'server: https://.*:6443'
        replace: "server: https://{{ kube_vip_address }}:6443"

    - name: Smoke test external kubeconfig
      command: >
        kubectl --kubeconfig {{ kubeconfig_external_path }} get nodes
      register: external_kubeconfig_test
      changed_when: false
      failed_when: false

    - debug:
        msg: >
          external kubeconfig test: rc={{ external_kubeconfig_test.rc }};
          stdout={{ external_kubeconfig_test.stdout | default('') }}

- name: Install Clabernetes manager (optional)
  hosts: kube_control_plane[0]
  become: true
  gather_facts: false
  tags:
    - clabernetes
    - clabernetes_install
  vars:
    clabernetes_namespace_value: "{{ clabernetes_namespace | default('c9s') }}"
    clabernetes_release_name_value: "{{ clabernetes_release_name | default('clabernetes') }}"
    clabernetes_chart_ref_value: "{{ clabernetes_chart_ref | default('oci://ghcr.io/srl-labs/clabernetes/clabernetes') }}"
    clabernetes_helm_binary_value: "{{ clabernetes_helm_binary | default('helm') }}"
    clabernetes_kubeconfig: "{{ lookup('env','HOME') | default(ansible_env.HOME) }}/.kube/config"
  tasks:
    - name: Skip Clabernetes installation when disabled
      ansible.builtin.meta: end_play
      when: not clabernetes_enabled | bool

    - name: Check if helm binary is available on controller
      delegate_to: localhost
      run_once: true
      ansible.builtin.command: "{{ clabernetes_helm_binary_value }} version --short"
      register: clabernetes_helm_check
      changed_when: false
      failed_when: false

    - name: Install Helm when missing
      delegate_to: localhost
      run_once: true
      become: true
      ansible.builtin.package:
        name: helm
        state: present
      when: clabernetes_helm_check.rc != 0

    - name: Re-check helm binary after installation
      delegate_to: localhost
      run_once: true
      ansible.builtin.command: "{{ clabernetes_helm_binary_value }} version --short"
      register: clabernetes_helm_check_verify
      changed_when: false
      failed_when: clabernetes_helm_check_verify.rc != 0

    - name: Install/upgrade Clabernetes manager via Helm
      delegate_to: localhost
      run_once: true
      ansible.builtin.command: >
        {{ clabernetes_helm_binary_value }}
        upgrade --install
        --create-namespace
        --namespace {{ clabernetes_namespace_value }}
        {{ clabernetes_release_name_value }}
        {{ clabernetes_chart_ref_value }}
      environment:
        KUBECONFIG: "{{ clabernetes_kubeconfig }}"
      register: clabernetes_helm_result
      changed_when: "'Release ' in (clabernetes_helm_result.stdout | default('')) or 'Release ' in (clabernetes_helm_result.stderr | default(''))"

    - name: Debug Clabernetes Helm result
      ansible.builtin.debug:
        var: clabernetes_helm_result.stdout_lines
      when: clabernetes_helm_result.stdout is defined
