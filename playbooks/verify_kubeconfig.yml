---
- name: Verify kubeconfig layout for control-plane ansible user
  hosts: kube_control_plane
  become: true
  gather_facts: false

  tasks:
    - name: Stat kube dir for ansible user
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/.kube"
      register: kube_dir

    - name: Stat kubeconfig for ansible user
      ansible.builtin.stat:
        path: "/home/{{ ansible_user }}/.kube/config"
      register: kube_config

    - name: Stat root kubeconfig copy
      ansible.builtin.stat:
        path: /root/.kube/config
      register: root_kube_config

    - name: Assert kube dir exists with correct ownership and mode
      ansible.builtin.assert:
        that:
          - kube_dir.stat.exists
          - kube_dir.stat.isdir
          - kube_dir.stat.pw_name == ansible_user
          - kube_dir.stat.gr_name == ansible_user
          - kube_dir.stat.mode == "0700"
        fail_msg: >-
          /home/{{ ansible_user }}/.kube is not present or has wrong
          owner/group/mode on {{ inventory_hostname }} (got:
          exists={{ kube_dir.stat.exists | default(false) }},
          mode={{ kube_dir.stat.mode | default('none') }},
          owner={{ kube_dir.stat.pw_name | default('none') }},
          group={{ kube_dir.stat.gr_name | default('none') }})

    - name: Assert kubeconfig exists with correct ownership and mode
      ansible.builtin.assert:
        that:
          - kube_config.stat.exists
          - kube_config.stat.isreg
          - kube_config.stat.pw_name == ansible_user
          - kube_config.stat.gr_name == ansible_user
          - kube_config.stat.mode == "0600"
        fail_msg: >-
          /home/{{ ansible_user }}/.kube/config is not present or has wrong
          owner/group/mode on {{ inventory_hostname }} (got:
          exists={{ kube_config.stat.exists | default(false) }},
          mode={{ kube_config.stat.mode | default('none') }},
          owner={{ kube_config.stat.pw_name | default('none') }},
          group={{ kube_config.stat.gr_name | default('none') }})

    - name: Assert root kubeconfig copy is absent
      ansible.builtin.assert:
        that:
          - not root_kube_config.stat.exists
        fail_msg: >-
          /root/.kube/config still exists on {{ inventory_hostname }} but
          should have been removed by the cluster playbook.

    - name: Validate kubeconfig by calling kubectl as ansible user
      ansible.builtin.command:
        cmd: kubectl --kubeconfig="/home/{{ ansible_user }}/.kube/config" config current-context
      register: kubectl_context
      changed_when: false

    - name: Assert kubectl can read current context
      ansible.builtin.assert:
        that:
          - kubectl_context.rc == 0
          - kubectl_context.stdout | length > 0
        fail_msg: >-
          kubectl failed to read current context using
          /home/{{ ansible_user }}/.kube/config on {{ inventory_hostname }}.
          rc={{ kubectl_context.rc }}, stdout={{ kubectl_context.stdout }},
          stderr={{ kubectl_context.stderr }}
